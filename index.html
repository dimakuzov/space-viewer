<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luma AI Viewer - WASD Controls</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
        }
        canvas {
            display: block;
        }
        .controls-info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 100;
        }
        .controls-info h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="controls-info">
        <h3>Controls:</h3>
        <div>W/S - Forward/Backward</div>
        <div>A/D - Left/Right</div>
        <div>Q/E - Up/Down</div>
        <div>Mouse - Look Around</div>
        <div>Shift - Run (faster movement)</div>
    </div>

    <canvas></canvas>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.157.0/examples/jsm/",
            "@lumaai/luma-web": "https://unpkg.com/@lumaai/luma-web@0.2.0/dist/library/luma-web.module.js"
        }
    }
    </script>

    <script type="module">
    import { WebGLRenderer, PerspectiveCamera, Scene, Vector3 } from 'three';
    import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
    import { LumaSplatsThree } from '@lumaai/luma-web';

    let canvas = document.querySelector('canvas');
    let renderer = new WebGLRenderer({
        canvas: canvas,
        antialias: false
    });
    renderer.setSize(window.innerWidth, window.innerHeight, false);

    let scene = new Scene();
    let camera = new PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 0, 2);

    // Используем PointerLockControls для FPS-стиля управления
    let controls = new PointerLockControls(camera, document.body);

    // Клик для захвата курсора
    document.addEventListener('click', () => {
        controls.lock();
    });

    // Переменные для движения
    const moveSpeed = 0.1;
    const runMultiplier = 2;
    let moveForward = false;
    let moveBackward = false;
    let moveLeft = false;
    let moveRight = false;
    let moveUp = false;
    let moveDown = false;
    let canJump = false;

    const velocity = new Vector3();
    const direction = new Vector3();

    // Обработчики клавиатуры
    const onKeyDown = function(event) {
        switch(event.code) {
            case 'ArrowUp':
            case 'KeyW':
                moveForward = true;
                break;
            case 'ArrowLeft':
            case 'KeyA':
                moveLeft = true;
                break;
            case 'ArrowDown':
            case 'KeyS':
                moveBackward = true;
                break;
            case 'ArrowRight':
            case 'KeyD':
                moveRight = true;
                break;
            case 'KeyQ':
                moveUp = true;
                break;
            case 'KeyE':
                moveDown = true;
                break;
            case 'Space':
                if (canJump === true) velocity.y += 350;
                canJump = false;
                break;
        }
    };

    const onKeyUp = function(event) {
        switch(event.code) {
            case 'ArrowUp':
            case 'KeyW':
                moveForward = false;
                break;
            case 'ArrowLeft':
            case 'KeyA':
                moveLeft = false;
                break;
            case 'ArrowDown':
            case 'KeyS':
                moveBackward = false;
                break;
            case 'ArrowRight':
            case 'KeyD':
                moveRight = false;
                break;
            case 'KeyQ':
                moveUp = false;
                break;
            case 'KeyE':
                moveDown = false;
                break;
        }
    };

    document.addEventListener('keydown', onKeyDown);
    document.addEventListener('keyup', onKeyUp);

    // Загружаем Luma splat
    let splat = new LumaSplatsThree({
        source: 'https://lumalabs.ai/capture/d80d4876-cf71-4b8a-8b5b-49ffac44cd4a'
    });
    scene.add(splat);

    // Обработка изменения размера окна
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Основной цикл рендеринга
    renderer.setAnimationLoop(() => {
        // Определяем скорость (быстрее если зажат Shift)
        const currentSpeed = event && event.shiftKey ? moveSpeed * runMultiplier : moveSpeed;

        // Сбрасываем velocity
        velocity.x = 0;
        velocity.z = 0;
        velocity.y = 0;

        direction.z = Number(moveForward) - Number(moveBackward);
        direction.x = Number(moveRight) - Number(moveLeft);
        direction.y = Number(moveUp) - Number(moveDown);
        direction.normalize();

        if (moveForward || moveBackward) velocity.z -= direction.z * currentSpeed;
        if (moveLeft || moveRight) velocity.x -= direction.x * currentSpeed;
        if (moveUp || moveDown) velocity.y += direction.y * currentSpeed;

        // Применяем движение
        controls.moveRight(-velocity.x);
        controls.moveForward(-velocity.z);

        // Вертикальное движение
        camera.position.y += velocity.y;

        renderer.render(scene, camera);
    });
    </script>
</body>
</html>